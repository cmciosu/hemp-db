{% extends "master.html" %}

{% block title %}
  Hemp Stakeholder Database
{% endblock %}

{% block content %}

{% if messages %}
  <div class="alert alert-success alert-dismissible fade show" role="alert" style="width: 40vw; margin-left: 20px; margin-top: 10px;">
    {% for message in messages %}
      <li{% if message.tags %} class="{{ message.tags }}"{% endif %} style="list-style-type: none;">{{ message }}</li>
    {% endfor %}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
{% endif %}

<div class="btn-group" style="display: block;" role="group" aria-label="Button group with nested dropdown">
  {% if user.is_staff %}
    <button type="button" class="btn btn-secondary rounded-pill mx-3 my-2 px-3" data-bs-toggle="modal" data-bs-target="#createModal">Create</button>
    <button type="button" class="btn btn-secondary rounded-pill mx-3 my-2 px-3" data-bs-toggle="modal" data-bs-target="#importModal">Import</button>
    <a href="{% url 'export-companies' %}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3">Export</a>
    {% endif %}
    
    <div class="btn-group mx-5" role="group">
      <form method="post" action="/companies/search/">
        {% csrf_token %}
        {{ searchForm.q }}
        <button class="btn btn-outline-success rounded-pill mx-3 my-2 px-3" type="submit">Search</a>
      </form>
    </div>
    {% if query %}
      <a class="btn btn-secondary rounded-pill mx-3 my-2 px-3" href="{%url 'companies'%}"> {{ query }} x</a>
    {% endif %}
    <div style="float: right;">
      {% if query %}
        {% if page > 1 %}
            <a href="/companies/search/?page={{ page|add:"-1" }}&query={{ query }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Previous Page </a>
          {% else %}
            <a href="/companies/search/?page={{ page|add:"-1" }}&query={{ query }}" class="btn btn-secondary disabled rounded-pill mx-3 my-2 px-3"> Previous Page </a>
        {% endif %}
        <a href="/companies/search/?page={{ page|add:"1" }}&query={{ query }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Next Page </a>
      {% else %}
        {% if page > 1 %}
            <a href="/companies/?page={{ page|add:"-1" }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Previous Page </a>
          {% else %}
            <a href="/companies/?page={{ page|add:"-1" }}" class="btn btn-secondary disabled rounded-pill mx-3 my-2 px-3"> Previous Page </a>
        {% endif %}
        <a href="/companies/?page={{ page|add:"1" }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Next Page </a>
      {% endif %}
    </div>
</div>

  <table class="table table-bordered border-success table-sm">
    <thead>
      <tr>
        <th scope="col">Company Name</th>
        <th scope="col">Status</th>
        <th scope="col">Industry</th>
        <th scope="col">Stakeholder Category</th>
        <th scope="col">Stakeholder Group</th>
        <th scope="col">Development Stage</th>
        <th scope="col">Product Group</th>
        <th scope="col">Description</th>
        <th scope="col">Solution</th>
        {%if user.is_staff %}
          <th scope="col">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% load cachalot cache %}
      {% cache 3600 company companies company.Category company.stakeholderGroup company.Stage company.Solutions company.productGroup %}
        {% with cachedCompanies=companies %}
          {% for company in cachedCompanies %}
            <tr>
              <td><a href="{% url 'company-view' company.id %}">{{ company.Name }}</a></td>
              <td style="{% if company.Status.status == 'Active' %}color:green{% else %}color:red{% endif %}"><b>{{ company.Status.status }}</b></td>
              <td>{{ company.Industry.industry }}</td>
              <td>{{ company.Category.first }}</td>
              <td>{{ company.stakeholderGroup.first }}</td>
              <td>{{ company.Stage.first }}</td>
              <td>{{ company.productGroup.first }}</td>
              <td>{{ company.Description|truncatechars:100 }}</td>
              <td>{{ company.Solutions.first }}</td>
              {%if user.is_staff %}
                <td>
                  <div style="display: flex; gap: 5px;">
                    <a href="{% url 'edit-company' company.id %}" class="btn btn-secondary">Edit</a>
                    <a type="button" class="btn btn-danger" href="/remove_companies/{{ company.id }}"> 
                    <!-- Delete -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"></path>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"></path>
                    </svg>
                    </a>
                  </div>
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        {% endwith %}
      {% endcache %}
    </tbody>
  </table>

  <div class="modal" id="createModal">
    <div class="modal-dialog">
      <div class="modal-content">
  
        <div class="modal-header">
          <h4 class="modal-title">Create</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <p>
          * = required
        </p>

        <form id="upload_form" method="post" action="/companies/">

          {% csrf_token %}
          <div style="display: block; margin-left: 10px; margin-right: 10px;">
            <style>
              ul {
                list-style-type: none;
              }
            </style>
            {% for field in form %}
              {% if field.field.required %}
                <p>* {{ field.label_tag }}</p>
              {% else %}
               <p> {{ field.label_tag }} </p>
              {% endif %}
              <p> {{ field }} </p>
            {% endfor %}

            {% if form.errors %}
              {% for field in form %}
                {% for error in field.errors %}
                  <p> {{ error }} </p>
                {% endfor %}
              {% endfor %}
            {% endif %}
          </div>
          <div class="modalFooter">
            <button type="submit" class="btn btn-danger" value="Submit" style="float: right; margin: 5px;">Submit</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal" style="float: right; margin: 5px;">Close</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="modal" id="importModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <div class="modal-header">
          <h4 class="modal-title">Import</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
  
        <div class="modal-body">
          Select file: 
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <button type="submit">Upload File</button>
          </form>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>
  <div style="display: flex; justify-content: center; gap: 15px;">
    {% if query %}
      {% if page > 1 %}
          <a href="/companies/search/?page={{ page|add:"-1" }}&query={{ query }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Previous Page </a>
        {% else %}
          <a href="/companies/search/?page={{ page|add:"-1" }}&query={{ query }}" class="btn btn-secondary disabled rounded-pill mx-3 my-2 px-3"> Previous Page </a>
      {% endif %}
      <a href="/companies/search/?page={{ page|add:"1" }}&query={{ query }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Next Page </a>
    {% else %}
      {% if page > 1 %}
          <a href="/companies/?page={{ page|add:"-1" }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Previous Page </a>
        {% else %}
          <a href="/companies/?page={{ page|add:"-1" }}" class="btn btn-secondary disabled rounded-pill mx-3 my-2 px-3"> Previous Page </a>
      {% endif %}
      <a href="/companies/?page={{ page|add:"1" }}" class="btn btn-secondary rounded-pill mx-3 my-2 px-3"> Next Page </a>
  {% endif %}
  </div>
{% endblock %}